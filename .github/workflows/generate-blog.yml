name: Generate Blog Content

on:
  schedule:
    - cron: "0 */3 * * *" # Run every 3 hours
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  # This job runs first to "wake up" the serverless backend
  warm-up:
    runs-on: ubuntu-latest
    steps:
      - name: Basic Health Check
        run: |
          echo "Performing basic health check to warm up the server..."
          curl --fail -s -m 15 "https://techinsightsai.onrender.com/health" || echo "Health check failed, but continuing to trigger generation jobs."

  # This job runs in parallel for each genre after the warm-up is complete
  generate-blog:
    needs: warm-up # Ensures the warm-up job runs first
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Ensures all jobs run even if one fails
      matrix:
        # Defines the list of genres to generate
        genre: ['general', 'ai-ml', 'cybersecurity', 'coding', 'emerging-tech', 'tech-news']
    steps:
      - name: Trigger Blog Generation for ${{ matrix.genre }}
        run: |
          # Prepare the JSON payload. It's empty for 'general' and contains the genre for others.
          JSON_PAYLOAD="{}"
          if [ "${{ matrix.genre }}" != "general" ]; then
            JSON_PAYLOAD=$(printf '{"genre":"%s"}' "${{ matrix.genre }}")
          fi
          
          echo "Generating blog for genre: ${{ matrix.genre }}"
          
          # Send the API request to trigger blog generation
          curl --fail --show-error -s -X POST "https://techinsightsai.onrender.com/api/blogs/generate" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"