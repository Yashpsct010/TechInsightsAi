name: Generate Blog Content

on:
  schedule:
    - cron: "0 */3 * * *" # Run every 3 hours
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    steps:
      - name: Generate blogs for all genres
        run: |
          echo "Starting blog generation process..."

          # Function to call API and handle potential errors
          generate_blog() {
            local genre=$1
            local genre_display=$2
            
            echo "Generating ${genre_display} blog..."
            local response=$(curl -s -X POST "https://techinsightsai-backend.vercel.app/api/blogs/generate" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              -d "{\"genre\":\"${genre}\"}")
            
            echo "${genre_display} blog response: $response"
            
            # Check if response contains an error
            if [[ $response == *"error"* ]]; then
              echo "WARNING: Possible error in ${genre_display} blog generation"
            fi
            
            # Much longer delay between requests - 60 seconds
            sleep 60
          }

          # Generate general blog (null genre)
          echo "Generating general blog..."
          RESPONSE=$(curl -s -X POST "https://techinsightsai-backend.vercel.app/api/blogs/generate" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "General blog response: $RESPONSE"
          sleep 60

          # Generate specific genre blogs
          generate_blog "ai-ml" "AI/ML"
          generate_blog "cybersecurity" "Cybersecurity"
          generate_blog "coding" "Coding"
          generate_blog "emerging-tech" "Emerging Tech"
          generate_blog "tech-news" "Tech News"

          echo "All blog generation requests completed at $(date)"
